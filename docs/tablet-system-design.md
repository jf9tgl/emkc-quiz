# タブレット早押しボタンシステム 設計書

## 1. システム概要

物理的な早押しボタンの代わりに、タブレットやスマートフォンのWebブラウザを使用した早押しボタンシステムです。
各プレイヤーがタブレットからアクセスし、画面上のボタンをタップすることで早押しができます。

## 2. システムの利点

### 2.1 物理ボタンと比較した利点

- **ハードウェア不要**: Arduinoや物理ボタンの配線が不要
- **柔軟性**: プレイヤー数の変更が容易
- **保守性**: ハードウェアの故障リスクがない
- **視覚的フィードバック**: 画面上で直接状態を確認可能
- **設定の容易さ**: プレイヤー名やスコアをリアルタイムで確認

### 2.2 デメリットと対策

| デメリット | 対策 |
|----------|------|
| 遅延の可能性 | WebSocket通信により最小限の遅延で実装 |
| 誤タップ | ボタンサイズを大きくし、押下後は無効化 |
| ネットワーク依存 | ローカルネットワークで運用し、接続状態を表示 |

## 3. システム構成

```
タブレット/スマホ (各プレイヤー)
    ↓ WebSocket (http://server:3001)
Node.js サーバー (ボタン押下処理)
    ↓ WebSocket ブロードキャスト
Next.js クライアント
    ├─ /button  (タブレット用ボタン画面)
    ├─ /admin   (司会者用コントロール画面)
    └─ /display (観客用大画面表示)
```

## 4. 技術仕様

### 4.1 フロントエンド

#### ボタンページ (`/button`)

**URL**: `http://localhost:3000/button`

**機能**:
- 5人分の大型ボタンを表示
- クイズがアクティブな時のみボタンが有効
- 押下済みの場合は順位を表示
- プレイヤー名とスコアを表示
- 接続状態をリアルタイム表示

**UIコンポーネント**:
- ボタン: 大きなタップ可能なカード
- 状態インジケーター: 押下済み、順位表示
- 接続状態表示: 右上に常時表示
- アニメーション: タップ時のフィードバック

**レスポンシブ対応**:
- モバイル: 1列表示
- タブレット: 2列表示
- デスクトップ: 3列表示

### 4.2 バックエンド

#### Socket.IO イベント

**新規追加イベント**:

```typescript
// クライアント → サーバー
socket.on("pressButton", (data: { buttonId: number; timestamp: number }) => {
    // Arduinoと同じロジックでボタン押下を処理
    handleButtonPress({
        type: "pressedButton",
        buttonId: data.buttonId,
        timestamp: data.timestamp,
    });
});
```

**処理フロー**:
1. タブレットからボタンIDとタイムスタンプを受信
2. クイズのアクティブ状態を確認
3. プレイヤーの押下状態を確認
4. ボタン押下を記録し、順位を設定
5. 全クライアントに状態をブロードキャスト

### 4.3 データフロー

```
[タブレット] ボタンタップ
    ↓
[Frontend] socketManager.emit("pressButton", { buttonId, timestamp })
    ↓
[Server] handleButtonPress() 実行
    ↓
[Server] quizState 更新（pressed: true, order: N）
    ↓
[Server] io.emit("buttonPressed", { buttonId, timestamp })
[Server] io.emit("state", quizState)
    ↓
[All Clients] 状態更新を受信
    ↓
[タブレット] ボタン無効化 & 順位表示
[Display] 回答者表示 & 効果音再生
[Admin] 回答者リスト更新
```

## 5. UIデザイン

### 5.1 ボタンページのレイアウト

```
┌─────────────────────────────────────┐
│  早押しボタン              [接続状態] │
│  問題が出題されています！            │
├─────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐│
│  │    1    │ │    2    │ │    3    ││
│  │Player 1 │ │Player 2 │ │Player 3 ││
│  │  0pt    │ │  10pt   │ │  20pt   ││
│  └─────────┘ └─────────┘ └─────────┘│
│  ┌─────────┐ ┌─────────┐            │
│  │    4    │ │    5    │            │
│  │Player 4 │ │Player 5 │            │
│  │  0pt    │ │  10pt   │            │
│  └─────────┘ └─────────┘            │
├─────────────────────────────────────┤
│       3人が回答しています            │
└─────────────────────────────────────┘
```

### 5.2 ボタンの状態遷移

```
[待機中]
  ↓ クイズ開始
[有効]
  ↓ タップ
[押下中（アニメーション）]
  ↓ 0.3秒後
[無効（順位表示）]
  ↓ クイズ終了
[待機中]
```

### 5.3 カラースキーム

各プレイヤーに固有の色を割り当て:
- Player 1: Red (赤)
- Player 2: Blue (青)
- Player 3: Green (緑)
- Player 4: Yellow (黄)
- Player 5: Purple (紫)
- Player 6: Pink (ピンク)

## 6. セットアップ手順

### 6.1 サーバー起動

```bash
# サーバーを起動
cd server
npm install
npm run dev
```

### 6.2 クライアント起動

```bash
# フロントエンドを起動
cd frontend
npm install
npm run dev
```

### 6.3 タブレット接続

各プレイヤーのタブレット/スマートフォンで以下のURLにアクセス:

```
http://[サーバーのIPアドレス]:3000/button
```

例: `http://192.168.1.100:3000/button`

### 6.4 管理画面接続

司会者用PCで以下のURLにアクセス:

```
http://localhost:3000/admin  (コントロール画面)
http://localhost:3000/display (観客用大画面)
```

## 7. ネットワーク設定

### 7.1 推奨構成

```
[ルーター/アクセスポイント]
    ├── サーバーPC (192.168.1.100)
    │     ├── Node.js サーバー (:3001)
    │     └── Next.js クライアント (:3000)
    │
    ├── タブレット1 (192.168.1.101) → /button
    ├── タブレット2 (192.168.1.102) → /button
    ├── タブレット3 (192.168.1.103) → /button
    ├── タブレット4 (192.168.1.104) → /button
    └── タブレット5 (192.168.1.105) → /button
```

### 7.2 ファイアウォール設定

サーバーPCで以下のポートを開放:
- **3000番ポート**: Next.js (HTTP)
- **3001番ポート**: Node.js サーバー (WebSocket)

### 7.3 環境変数設定

フロントエンド (`.env.local`):
```bash
NEXT_PUBLIC_SERVER_URL=http://192.168.1.100:3001
```

## 8. 運用方法

### 8.1 事前準備

1. サーバーとクライアントを起動
2. 各タブレットで `/button` にアクセス
3. 接続状態が「接続中」になることを確認
4. プレイヤー名を管理画面から設定

### 8.2 クイズ進行

1. 司会者が管理画面から問題を出題
2. タブレットのボタンが有効化される
3. プレイヤーがボタンをタップ
4. 順位が記録され、大画面に表示
5. 司会者が正解/不正解を判定
6. 次の問題へ

### 8.3 トラブルシューティング

| 問題 | 原因 | 対処法 |
|-----|------|--------|
| ボタンが反応しない | ネットワーク切断 | 接続状態を確認し、再接続 |
| 順位がおかしい | 同時押し | サーバー側でタイムスタンプで判定 |
| ボタンが有効にならない | クイズ非アクティブ | 管理画面から問題を出題 |

## 9. パフォーマンス仕様

- **応答時間**: ボタンタップから表示まで100ms以内（ローカルネットワーク）
- **同時接続**: 最大10デバイス（5プレイヤー + 管理 + 表示 + 予備）
- **通信プロトコル**: WebSocket（低遅延双方向通信）

## 10. セキュリティ考慮事項

- ローカルネットワーク内でのみ使用
- 外部インターネットへの公開は非推奨
- 必要に応じて認証機能を追加可能

## 11. 拡張機能（将来実装）

### 11.1 認証機能

プレイヤーごとにログイン画面を追加し、専用のボタンを割り当て

### 11.2 モバイルアプリ化

PWA（Progressive Web App）として実装し、オフラインでも動作可能に

### 11.3 統計機能

- プレイヤーごとの平均反応時間
- 正解率の記録
- リーダーボード表示

### 11.4 マルチルーム対応

複数のクイズセッションを同時に開催可能に

## 12. 移行ガイド（Arduinoから）

### 12.1 既存システムとの互換性

タブレットシステムは既存のArduinoシステムと**完全に互換性**があります。

- サーバー側の処理ロジックは同一
- `handleButtonPress()` 関数を共有
- データ形式も統一

### 12.2 段階的移行

1. **Phase 1**: Arduinoシステムを維持しつつ、タブレットページを追加
2. **Phase 2**: テストイベントでタブレットシステムを検証
3. **Phase 3**: 本番環境でタブレットシステムに完全移行

### 12.3 ハイブリッド運用

両方のシステムを同時に使用することも可能:
- 一部のプレイヤーはArduinoボタン
- 残りのプレイヤーはタブレット

## 付録A: ファイル構成

```
frontend/
├── src/
│   ├── app/
│   │   ├── button/
│   │   │   └── page.tsx          # タブレットボタンページ
│   │   ├── admin/
│   │   │   └── page.tsx          # 管理画面
│   │   └── display/
│   │       └── page.tsx          # 大画面表示
│   ├── store/
│   │   └── quiz-store.ts         # 状態管理
│   └── lib/
│       ├── socket.ts             # WebSocket管理
│       └── types.ts              # 型定義

server/
└── server.ts                     # バックエンドサーバー
    - pressButton イベント処理を追加
```

## 付録B: 推奨タブレット仕様

- **画面サイズ**: 7インチ以上
- **OS**: iOS 12以降、Android 8以降
- **ブラウザ**: Safari、Chrome最新版
- **Wi-Fi**: 802.11n以上

---

**更新履歴**:
- 2025-10-16: 初版作成（タブレットシステム実装）

# システムアーキテクチャ図

## 全体構成

```
┌─────────────────────────────────────────────────────────────────┐
│                         クイズシステム                            │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    クライアント層 (Frontend)                      │
│                         Port: 3000                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   /button    │  │    /admin    │  │   /display   │          │
│  │              │  │              │  │              │          │
│  │ タブレット用  │  │  司会者用    │  │  観客用      │          │
│  │ 早押しボタン  │  │ コントロール │  │ 大画面表示   │          │
│  │              │  │              │  │              │          │
│  │ • ボタンUI   │  │ • 問題管理   │  │ • 問題表示   │          │
│  │ • スコア表示 │  │ • 正誤判定   │  │ • 回答者表示 │          │
│  │ • 順位表示   │  │ • 名前変更   │  │ • スコア表示 │          │
│  │ • 状態確認   │  │ • 設定変更   │  │ • 効果音再生 │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│         ↓                  ↓                 ↓                  │
│         └──────────────────┴─────────────────┘                  │
│                            │                                    │
│                  WebSocket接続 (Socket.IO)                      │
│                            │                                    │
└────────────────────────────┼────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────┐
│                   サーバー層 (Backend)                            │
│                       Port: 3001                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Node.js + Express + Socket.IO                                  │
│                                                                  │
│  ┌────────────────────────────────────────────────────┐        │
│  │           WebSocketイベントハンドラー               │        │
│  ├────────────────────────────────────────────────────┤        │
│  │                                                     │        │
│  │  • pressButton        (タブレットボタン押下)       │        │
│  │  • setQuestion        (問題設定)                   │        │
│  │  • correctAnswer      (正解判定)                   │        │
│  │  • incorrectAnswer    (不正解判定)                 │        │
│  │  • updatePlayerName   (プレイヤー名変更)           │        │
│  │  • endQuiz            (クイズ終了)                 │        │
│  │  • setShowHint        (ヒント表示制御)             │        │
│  │  • setShowAnswer      (答え表示制御)               │        │
│  │                                                     │        │
│  └────────────────────────────────────────────────────┘        │
│                            │                                    │
│  ┌────────────────────────────────────────────────────┐        │
│  │              状態管理 (In-Memory)                  │        │
│  ├────────────────────────────────────────────────────┤        │
│  │                                                     │        │
│  │  • QuizState     (クイズ状態)                      │        │
│  │  • QuizSetting   (設定値)                          │        │
│  │  • UISettings    (UI設定)                          │        │
│  │  • Players[]     (プレイヤー情報)                  │        │
│  │                                                     │        │
│  └────────────────────────────────────────────────────┘        │
│                            │                                    │
│           ┌────────────────┴────────────────┐                  │
│           │                                 │                  │
│           ↓                                 ↓                  │
│  ┌─────────────────┐              ┌─────────────────┐         │
│  │  Arduino入力     │              │ WebSocket出力   │         │
│  │  (オプション)    │              │ (ブロードキャスト)│         │
│  │                  │              │                  │         │
│  │ • シリアル通信   │              │ • state          │         │
│  │ • JSON解析       │              │ • buttonPressed  │         │
│  │ • ボタン押下処理 │              │ • correctAnswer  │         │
│  │                  │              │ • incorrectAnswer│         │
│  └─────────────────┘              └─────────────────┘         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## データフロー

### 1. タブレットボタン押下フロー

```
[タブレット] ボタンタップ
    ↓
[Frontend] 
    ↓ socketManager.emit("pressButton", { buttonId, timestamp })
[Backend] イベント受信
    ↓
[Backend] handleButtonPress() 実行
    ↓ クイズアクティブ確認
    ↓ プレイヤー状態確認
    ↓ 順位計算
[Backend] QuizState 更新
    • player.pressed = true
    • player.order = N
    • pressedOrder.push(playerId)
    ↓
[Backend] ブロードキャスト
    ↓ io.emit("buttonPressed", { buttonId, timestamp })
    ↓ io.emit("state", quizState)
[All Clients] 状態更新
    ↓
[タブレット] ボタン無効化 + 順位表示
[Display] 回答者表示 + 効果音
[Admin] リスト更新
```

### 2. 問題出題フロー

```
[Admin] 問題入力 + 出題ボタン
    ↓
[Frontend]
    ↓ socketManager.emit("setQuestion", questionData)
[Backend] イベント受信
    ↓
[Backend] QuizState 更新
    • questionData = data
    • isActive = true
    • pressedOrder = []
    • すべてのプレイヤーをリセット
    ↓
[Backend] ブロードキャスト
    ↓ io.emit("state", quizState)
[All Clients] 状態更新
    ↓
[タブレット] ボタン有効化
[Display] 問題表示
[Admin] 状態表示
```

### 3. 正解/不正解判定フロー

```
[Admin] 正解/不正解ボタン
    ↓
[Frontend]
    ↓ socketManager.emit("correctAnswer" | "incorrectAnswer")
[Backend] イベント受信
    ↓
[Backend] 
    ↓ pressedOrder[0] を取得
    ↓ スコア計算
    ↓ QuizState 更新
[Backend] correctAnswer()
    • player.score += correctPoints
    • クイズ終了処理
[Backend] incorrectAnswer()
    • player.score += incorrectPoints
    • プレイヤーを pressedOrder から削除
    • 残りのプレイヤーの順位を再計算
    ↓
[Backend] ブロードキャスト
    ↓ io.emit("correctAnswer" | "incorrectAnswer", { playerId })
    ↓ io.emit("state", quizState)
[All Clients] 状態更新
    ↓
[タブレット] スコア更新
[Display] アニメーション + スコア更新
[Admin] 状態更新
```

## ネットワークトポロジー

```
┌──────────────────────────────────────────────────────────┐
│                      Wi-Fiルーター                        │
│                   (192.168.1.1)                          │
└────────┬────────────────────────┬──────────────┬─────────┘
         │                        │              │
         ↓                        ↓              ↓
┌─────────────────┐    ┌─────────────────┐    ┌──────────┐
│  サーバーPC      │    │ タブレット1     │    │タブレット2│
│ 192.168.1.100   │    │ 192.168.1.101   │    │...       │
│                 │    │                 │    │          │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │┌────────┐│
│ │Server :3001 │ │    │ │   /button   │ │    ││/button ││
│ └─────────────┘ │    │ │ (Player 1)  │ │    ││(Player2││
│ ┌─────────────┐ │    │ └─────────────┘ │    │└────────┘│
│ │Client :3000 │ │    │                 │    │          │
│ └─────────────┘ │    └─────────────────┘    └──────────┘
│                 │
│ ブラウザ:       │
│ • /admin        │
│ • /display      │
│   (プロジェクター)│
└─────────────────┘
```

## コンポーネント関係図

```
┌────────────────────────────────────────────────────────┐
│                   Frontend Components                  │
├────────────────────────────────────────────────────────┤
│                                                        │
│  app/                                                  │
│  ├── button/page.tsx        (タブレットボタン)        │
│  ├── admin/page.tsx         (管理画面)                │
│  └── display/page.tsx       (表示画面)                │
│                                                        │
│  components/                                           │
│  ├── admin/                                            │
│  │   ├── QuizControlPanel.tsx                         │
│  │   ├── QuestionSetupPanel.tsx                       │
│  │   ├── PlayerStatusPanel.tsx                        │
│  │   └── CurrentQuestionDisplay.tsx                   │
│  ├── display/                                          │
│  │   ├── QuestionDisplay.tsx                          │
│  │   ├── PlayersSection.tsx                           │
│  │   ├── PlayerCard.tsx                               │
│  │   └── PressOrderDisplay.tsx                        │
│  ├── ui/                                               │
│  │   └── ConnectionStatus.tsx                         │
│  └── audio/                                            │
│      └── SoundManager.tsx                              │
│                                                        │
│  lib/                                                  │
│  ├── socket.ts              (WebSocket管理)           │
│  ├── types.ts               (型定義)                  │
│  └── audio-synthesizer.ts   (音声合成)               │
│                                                        │
│  store/                                                │
│  └── quiz-store.ts          (状態管理: Zustand)       │
│                                                        │
└────────────────────────────────────────────────────────┘
                           │
                  WebSocket (Socket.IO)
                           │
┌────────────────────────────────────────────────────────┐
│                    Backend Server                      │
├────────────────────────────────────────────────────────┤
│                                                        │
│  server.ts                                             │
│  ├── Express Server                                    │
│  ├── Socket.IO Server                                  │
│  ├── イベントハンドラー                                 │
│  │   ├── connection()                                  │
│  │   ├── handleButtonPress()                           │
│  │   ├── correctAnswer()                               │
│  │   ├── incorrectAnswer()                             │
│  │   └── endQuiz()                                     │
│  ├── 状態管理                                          │
│  │   ├── quizState                                     │
│  │   ├── quizSetting                                   │
│  │   └── uiSettings                                    │
│  └── Arduino通信 (オプション)                          │
│      ├── SerialPort                                    │
│      └── initializeSerial()                            │
│                                                        │
└────────────────────────────────────────────────────────┘
```

## 状態遷移図

```
┌─────────────┐
│   初期状態   │
│ isActive=false│
│ players: [] │
└──────┬──────┘
       │
       │ setQuestion
       ↓
┌─────────────┐
│ アクティブ状態│
│ isActive=true │
│ ボタン有効化 │
└──────┬──────┘
       │
       │ pressButton (タブレット)
       ↓
┌─────────────┐
│  押下記録   │
│ pressed=true │
│ order=N      │
└──────┬──────┘
       │
       ├─── correctAnswer ──→ スコア加算 → クイズ終了
       │
       └─── incorrectAnswer → スコア減算 → プレイヤー削除
              ↓
        ┌─────────────┐
        │次のプレイヤー│
        │  が回答可能  │
        └─────────────┘
              │
              ├─── correctAnswer ──→ スコア加算 → クイズ終了
              │
              └─── incorrectAnswer → スコア減算 → プレイヤー削除
                     ↓
                   (繰り返し)
```

## セキュリティモデル

```
┌──────────────────────────────────────────────┐
│          ローカルネットワーク                  │
│        (推奨: プライベートネットワーク)         │
├──────────────────────────────────────────────┤
│                                              │
│  • 外部インターネットへの公開: ❌            │
│  • 認証: なし（信頼されたネットワーク内）     │
│  • 暗号化: なし（HTTPのみ）                   │
│  • ファイアウォール: ポート3000,3001開放必須 │
│                                              │
└──────────────────────────────────────────────┘

推奨構成:
• 専用Wi-Fiアクセスポイント使用
• WPA2/WPA3暗号化
• 限定的なデバイス接続
• 本番環境ではVLAN分離を推奨
```

## パフォーマンス仕様

```
┌─────────────────────────────────────────────┐
│            パフォーマンス目標                 │
├─────────────────────────────────────────────┤
│                                             │
│  初期読み込み時間:     < 1秒                │
│  ボタン押下遅延:       < 100ms              │
│  状態同期遅延:         < 50ms               │
│  同時接続デバイス:     最大10台             │
│  WebSocket接続数:      最大15接続           │
│  メモリ使用量:         < 100MB (サーバー)   │
│                                             │
└─────────────────────────────────────────────┘

最適化手法:
• WebSocket使用（低遅延双方向通信）
• インメモリ状態管理（高速アクセス）
• 効率的なブロードキャスト
• クライアントサイドキャッシング
```

---

**最終更新**: 2025-10-16
**バージョン**: 1.0.0
